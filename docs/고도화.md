# figmaV3 코드베이스 분석 & 고도화 제안 (2025-08-28)

> 기준: 첨부 zip(`/src/figmaV3`) 소스 전수 스캔 결과. any 금지/React 최상위 훅 규칙/얕은 복사 업데이트 규약을 준수하는지 함께 점검했습니다.

---

## 0) 디렉터리 개요

```
src/figmaV3
├─ core/                # SSOT 타입 정의 + Registry(정의/렌더러)
├─ editor/              # 에디터 UI (좌/중앙/우 + 하단 도크)
│  ├─ components/       # 기본 컴포넌트 4종(Box/Button/Text/Image) + 등록 파일
│  ├─ leftPanel/        # Explorer / Composer(Templates+Palette) / Layers
│  ├─ centerPanel/      # Canvas(Shadow DOM), OverlayHost(Fragments)
│  ├─ rightPanel/       # Inspector(Common/PropsAuto/Styles, SchemaEditor)
│  ├─ bottomPanel/      # Actions / Flows / Data / Fragments + 고급 패널 호스트
│  ├─ common/           # WhenBuilder 등 공용 UI
│  ├─ ui/               # theme.module.css (에디터 토큰)
│  └─ useEditor.ts      # Zustand 구독 훅(useSyncExternalStore)
├─ runtime/             # 안전 표현식/DOM 변환/스타일 유틸/액션/플로우/영속화
└─ store/               # Zustand(에디터 상태+액션)
```

---

## 1) 핵심 아키텍처 정리

### 1.1 타입 SSOT — `core/types.ts`

* **Node / Project / EditorState / EditorUI**: 에디터 상태 전반 정의 (선택 노드, 좌우폭, 하단 패널 크기, 좌측 분할 비율, 모드, 전문가 모드, overlay 스택 등).
* **ComponentDefinition**: `defaults`(props/styles), `propsSchema(text/select)`, `capabilities`(허용 태그·스타일·이벤트/플로우 종류·바인딩 키), `templates`를 위한 오버라이드 지점 제공.
* **Action/Flow**: `SupportedEvent('onClick'|'onChange'|'onSubmit'|'onLoad')`, `ActionStep(Alert/SetData/SetProps/Http/Emit/Navigate/OpenFragment/CloseFragment)`, `FlowEdge(from→to + when.expr)`.
* **TagPolicy / TagPolicyMap**: 태그별 허용 attribute/스타일/void 여부 정책.
* **Dnd 타입 스텁**: palette→canvas, canvas 내부 정렬을 위한 타입만 정의(구현은 미포함).

### 1.2 레지스트리 — `core/registry.ts`

* **등록/조회**: `register(def, renderer)`, `getDefinition(id)`, `getRenderer(id)`, `listDefinitions()`.
* **렌더러 규약**: “호스트 요소만” 반환. Canvas가 스타일/선택/자식 주입을 담당.

### 1.3 스토어 — `store/editStore.ts`

* Zustand/vanilla 기반. **얕은 복사 update** 규약으로 일관성 유지.
* 액션 핵심:

    * 노드 추가/삭제/패치/props 병합/스타일 병합
    * **페이지** 추가/삭제/선택(rootId 스위칭)
    * **프래그먼트** 추가/삭제 + **오버레이 open/close 스택**
    * **FlowEdge** CRUD
    * 전역 `data`/`settings` 세팅
    * **hydrateDefaults(defId)**: 레지스트리 defaults를 노드에 반영

### 1.4 런타임 유틸 — `runtime/*`

* `expr.ts`: when 안전 파서/평가기(논리/비교/괄호/리터럴). 함수호출·\[] 인덱싱은 안전상 미지원.
* `binding.ts`: `{{ data.xxx }}` 머스태시 치환 + 안전 경로 접근.
* `domAttrs.ts`: React DOM 속성 변환(class→className, for→htmlFor) + 정책 기반 필터 + className 병합.
* `capabilities.ts`/`tagPolicyUtils.ts`: 태그/스타일 허용 판정, applied tag 계산(`__tag` → defaultTag → 'div').
* `styleUtils.ts`: kebab→camel, 숫자형 키 정규화, 얕은 병합 유틸.
* `actions.ts`/`flow.ts`: `runActions(steps,deps)` + from(event) 매칭/when 평가/적용.
* `persistence.ts`: **localStorage** 저장/복원 + API 스텁(`loadProject`/`saveProject`).

---

## 2) 에디터 UI 제공 기능 (현 버전)

### 2.1 상단바 — `topbar/PageBar.tsx`

* **현재 페이지 표시/전환**
* **모드**: Page / Component (토글)
* **Expert 모드**: 템플릿 필터 무시(단, TagPolicy는 항상 적용)

### 2.2 좌측 사이드바 — `leftPanel/LeftSidebar.tsx`

* **탭**: Explorer / Composer, 상·하 **리사이저**로 분할(비율 `ui.leftSplitPct` 저장)
* **Explorer.Top/Bottom** — `ExplorerPane.tsx`

    * Top: Page/Component 목록, 선택 시 하단 프리뷰 타겟 반영
    * Bottom: 선택 대상 요약 + **Page Create/Open/Duplicate/Delete**, **Name/Slug 편집** UX
    * **ProjectStylesheets** 관리(Inline/URL, enable 토글)
* **Composer.Top** — `TemplatesPanel.tsx` + `Palette.tsx`

    * **Templates**: 프로젝트 템플릿 생성(선택 노드 캡처 옵션), 검색/삽입
    * **Palette**: 레지스트리 컴포넌트 검색/삽입
* **Composer.Bottom** — `Layers.tsx`

    * 단순 트리(선택/삭제, 루트 삭제 금지)

### 2.3 중앙 — `centerPanel/Canvas.tsx`

* **Shadow DOM** 격리(사용자 CSS 주입: URL/inline)
* **선택 하이라이트**(outline), **Box만 컨테이너**로 자식 주입. void/비컨테이너는 형제 렌더.
* **이벤트 파이프라인**: 렌더러의 onClick과 에디터 onSelect를 `chainClick`으로 안전 결합 →
  선택/액션 동시 동작. `runActions` 호출은 Canvas에서 담당.

### 2.4 우측 — `rightPanel/Inspector.tsx`

* **CommonSection**: id/name/slot/tag 전환 + **Tag Attributes 동적 편집**(class 토큰 합치기, inline CSS 스캔으로 클래스 추천)
* **PropsAutoSection**: `propsSchema(text/select)` 기반 자동 UI → `updateNodeProps`로 저장
* **StylesSection**: 그룹(순서 고정)

    1. Layout 2) Typography 3) Position 4) Spacing 5) Border 6) Background 7) Effects 8) Custom

    * **TagPolicy + 템플릿 필터** 반영, **Expert 모드** 시 템플릿 필터 무시

### 2.5 하단 도크 — `bottomPanel/*`

* **Tabs**: Actions / Flows / Data / Fragments

    * **ActionsPanel**: (현재) **Component 스코프** 실동작 — 이벤트별 Step CRUD, Tag 전환/Tag Attrs를 SetProps 스텝으로 주입
    * **FlowsPanel**: from(node,event) → to(Navigate/OpenFragment/CloseFragment) + when.expr 구성/편집
    * **DataPanel**: 전역 JSON 편집/적용(`state.data`)
    * **FragmentsPanel**: 프래그먼트 CRUD + **오버레이 Open/Close**(OverlayHost로 렌더)
* **우측 고급 패널**: `BottomRightHost` — **SchemaEditor** 탑재(컴포넌트 propsSchema 프로젝트 오버라이드)
* **리사이저**: 상단(높이), 중앙(좌/우 폭) 모두 드래그 지원. 값은 `ui.bottomHeightPx`, `ui.bottomRight.widthPct` 등에 저장.

### 2.6 기본 컴포넌트 — `editor/components/*` (+ `registerBasics.ts`)

* **Box**(div 기본)
* **Text**(span 기본, `{{}}` 바인딩 지원)
* **Button**(button/a/div/span, href 지원, `__tag`/`__tagAttrs` 반영)
* **Image**(img void, 빈 src 방지)

### 2.7 영속화 — `editor/bootstrap.ts` + `runtime/persistence.ts`

* **로컬 자동 저장/복원**(debounce), UI/프로젝트 모두 처리.

---

## 3) 확인된 공백/제약 사항

* **onLoad 이벤트 트리거 미구현**: `SupportedEvent`에는 정의되어 있으나 Canvas에서 mount 시 실행 로직 부재.
* **DnD 미구현**: 타입만 존재. Palette→Canvas 드롭, 레이어 재정렬, 캔버스 내 before/after/inside 드롭 미구현.
* **Undo/Redo 없음**: 편집 이력 및 단축키(Cmd/Ctrl+Z/Y) 부재.
* **멀티셀렉션/그룹 작업 없음**: 다중 선택, 일괄 props/styles 수정 미지원.
* **레이어 대용량 대비 최적화 없음**: 가상 스크롤/접기/찾기 미구현.
* **A11y/검사기 없음**: alt 미지정, 버튼 type 누락, 대비/ARIA 경고 등 품질 점검 도구 부재.
* **HTTP 액션 개발자 UX 부족**: 모킹/응답 매핑, 런 로그/검증 UI 없음.
* **TagPolicy 편집 UI 없음**: 프로젝트 차원의 허용 attribute/style 정책을 시각적으로 관리할 수 없음.
* **템플릿 미리보기/카테고리/버전 없음**: 재사용성 강화를 위한 UX가 간소.
* **협업/원격 저장**: 로컬 전용. 프로젝트 import/export(파일)와 원격 API 연동이 스텁.

> 참고: 사용자 기억 메모에 있던 “dockRight(Layers docking) 상태 영속/리사이저” TODO는 본 코드에선 **우측 패널 폭/좌측 분할** 저장은 있으나 **Layers 도킹 위치 영속**은 구조상 아직 미포함입니다.

---

## 4) 고도화 제안 (우선순위 로드맵)

### P0 — 사용성이 바로 체감되는 빠른 개선

1. **onLoad 이벤트 지원**

    * Canvas.RenderNode mount 시 1회 실행(노드별 once). Flow도 동일 규약.
    * 액션 실패 격리 유지(try/catch), 런 로그에 기록.
2. **Undo/Redo(History)**

    * `store`에 ring-buffer(`past`/`future` 또는 `history[] + ptr`) 설계, 변화 지점은 store 액션 단일 진입점에서 스냅샷(diff) 기록.
    * 단축키, “되돌리기” 버튼 추가.
3. **레이어 UX 보강**

    * 접기/펼치기, 검색, 대용량 가상화(react-window) 도입.
4. **Actions 실행 로그 패널(Logs)**

    * BottomRight에 `Logs` kind 추가. 액션 스텝/HTTP 요청/응답/에러를 타임라인으로 시각화.

### P1 — 제작/조립 생산성

5. **DnD 구현**

    * Palette→Canvas insert, 레이어 트리 reorder(before/after/inside). `store.update` 기반 원자적 이동.
6. **멀티셀렉션/일괄 편집**

    * `ui.selectedIds: NodeId[]` 확장, Inspector에서 공통 키만 편집.
7. **TagPolicy 편집기**

    * Tag → allowedAttributes / styles.allow/deny 토글 UI. 템플릿/프로젝트 레벨 merge 정책 명시.
8. **템플릿 미리보기/카테고리/버전**

    * 썸네일(캔버스 렌더 캡처), 태그/카테고리 필터, 버전 히스토리 + 치환 적용(diff 안내).

### P2 — 앱 품질과 확장성

9. **A11y & 품질 검사기**

    * 버튼 type/alt 누락 경고, TabIndex, 콘트라스트 체크, 중복 id 탐지.
10. **HTTP 액션 모킹 & 바인딩**

    * 모킹 스위치, 응답 → `data.some.path` 자동 매핑 UI, 실패 재시도/백오프 옵션.
11. **원격 저장/불러오기 + 프로젝트 파일 I/O**

    * `persistence.ts` API 구현, JSON import/export, autosave 인디케이터.
12. **성능/안정성**

    * Canvas 대형 트리에서 메모리 프로파일링, 메모이제이션, batched updates.

---

## 5) 바로 적용 가능한 코드 스니펫

> *파일 전체가 아니라 “삽입 포인트” 중심의 안전 패치입니다. (규약: any 금지 / 얕은 복사 유지)*

### 5.1 Canvas: onLoad 트리거 (노드별 1회)

```tsx
// Canvas.tsx 내부
function RenderNode({ id, state }: { id: NodeId; state: EditorStoreState }) {
  const node = state.project.nodes[id] as Node;
  const renderer = getRenderer(node.componentId);
  const selected = state.ui.selectedId === id;

  // 🔹 onLoad 1회 실행
  React.useEffect(() => {
    const bag = (node.props as Record<string, unknown>).__actions as
      | Record<string, { when?: { expr?: string }; steps?: ActionStep[] }>
      | undefined;
    const steps = (bag as any)?.onLoad?.steps ?? [];
    const whenExpr = (bag as any)?.onLoad?.when?.expr as string | undefined;
    if (!steps || steps.length === 0) return;
    if (whenExpr) {
      const ok = evalWhenExpr(whenExpr, { data: state.data, node, project: state.project });
      if (!ok) return;
    }
    void runActions(steps as ActionStep[], {
      alert: (msg) => alert(msg),
      setData: state.setData,
      setProps: state.updateNodeProps,
      navigate: (toPageId) => state.selectPage(toPageId),
      openFragment: (fid) => state.openFragment(fid),
      closeFragment: (fid) => state.closeFragment(fid),
      http: async (m, url, body, headers) => {
        const res = await fetch(url, { method: m, headers, body: body ? JSON.stringify(body) : undefined });
        return await res.json().catch(() => undefined);
      },
      emit: (_topic) => {},
    });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ... (기존 렌더 로직 그대로)
}
```

### 5.2 BottomRightHost: Logs 패널 타입 추가(스캐폴드)

```ts
// core/types.ts
export type BottomRightPanelKind = 'SchemaEditor' | 'PropVisibility' | 'Logs' | 'None';
```

```tsx
// bottomPanel/BottomRightHost.tsx (switch 추가)
const title = ui.kind === 'SchemaEditor' ? 'Schema Editor'
  : ui.kind === 'Logs' ? 'Action Logs' : 'Advanced';
// ...
{ui.kind === 'SchemaEditor' && <SchemaEditor nodeId={nodeId} />}
{ui.kind === 'Logs' && <ActionLogs />} // TODO: 신규 컴포넌트
```

### 5.3 store: History 스캐폴드(설계 가이드)

* `history: EditorState[]`, `cursor: number`를 store 바깥 **모듈 스코프**에 두면 스냅샷 메모리 압박이 큼 →
  **Patch 기반**(작은 delta) 또는 **핵심 서브트리만** 스냅샷 권장.
* 안전안: `update(fn)` 진입점에서 **이전/현재의 `project`,`ui`만** JSON 비교(해시)로 변경 감지 후 push.
* 단축키 핸들러는 `ComponentEditor.tsx` 루트에서 등록.

```ts
// store/editStore.ts (개념 예시 — 실제 구현 시 파일 전체 리팩 권장)
let history: Array<Pick<EditorState,'project'|'ui'>> = [];
let cursor = -1;

function pushHistory(s: EditorState) {
  const snap = { project: s.project, ui: s.ui };
  history = history.slice(0, cursor+1).concat(snap);
  cursor = history.length - 1;
}

// update 내부 마지막에 변경 감지 후 pushHistory(s)
```

---

## 6) 테스트 시나리오 (체크리스트)

* **삽입/선택/삭제**: Palette→Box 삽입, 선택 하이라이트, Layers 반영.
* **Styles/Props**: Typography(FontWeight/Size), Layout(Flex), Spacing(Padding) 적용/저장/복원.
* **Actions**: Button.onClick → Alert/SetData/SetProps/Fragment Open/Close 확인, Logs 기록.
* **Flows**: node\:onClick → Navigate/OpenFragment 조건부 when.expr 적용.
* **Data 바인딩**: Text.content = `Hello {{data.user}}` 변경 즉시 반영.
* **onLoad**: 페이지 최초 진입 시 Node onLoad 실행(once), 조건식 true/false 검증.
* **영속화**: 새로고침 후 프로젝트/좌우폭/하단 높이 복원.

---

## 7) 결론

* 본 코드베이스는 **타입 안정성/레이어 분리/SSOT 타입/Shadow DOM** 등 기초 설계가 견고합니다.
* 단기간에는 **onLoad, Undo/Redo, Logs, Layers UX**로 사용성을 끌어올리고,
* 중기적으로 **DnD/멀티셀렉션/TagPolicy 편집/템플릿 UX**를 추가하면 Draftbit/Plasmic 범주의 에디터로서 경쟁력을 갖춥니다.
* 장기적으로 **원격 저장·협업·품질 검사기·성능 최적화**를 도입해 프로덕션 워크플로우를 지원하는 것을 권장합니다.
